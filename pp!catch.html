<!DOCTYPE html>
<html>
	<head>
		<title>pp!catch</title>
		<meta charset="UTF-8"/>
		<link rel="shortcut icon" type="image/png" href="/pp-catch/assets/osu-logo@2x.png"/>
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<script>
			/*
			config.read('config.ini')
			api_key = config.get("DEFAULT", "APIKey")
			# var setting
			if api_key is not "":
				osubdata = get_b_data(api_key)
			else:
				errors.configure(text="No API Key! Please indicate one in the config.ini.\n API Key can be found at \"https://osu.ppy.sh/p/api\".")
				pass
			stars = float(osubdata[0]["difficultyrating"])
			max_combo = int(osubdata[0]["max_combo"])
			try:
				miss = int(missI.get()) if int(missI.get()) < max_combo else 0
			except:
				miss = 0
			try:
				max_player_combo = int(max_player_comboI.get()) if int(max_player_comboI.get()) <= max_combo else max_combo - miss
			except:
				max_player_combo = max_combo - miss
			try:
				acc = float(accI.get()) if float(accI.get()) >= 0 and float(accI.get()) <= 100 else 100
			except:
				acc = float(100)
			ar = float(osubdata[0]["diff_approach"])

			# DT must be applied first since it is not a multiplier
			if DT.get() == 1:
				if ar > 5:
					ms = 200 + (11 - ar) * 100
				else:
					ms = 800 + (5 - ar) * 80
				if (ms < 300):
					ar = 11
				elif (ms < 1200):
					ar = round((11 - (ms - 300) / 150) * 100, 0) / 100
				else:
					ar = round((5 - (ms - 1200) / 120) * 100, 0) / 100

			ppdisplaying(round(finalpp, 2))
			*/
			function roundNumber(num, scale) {
				var number = Math.round(num * Math.pow(10, scale)) / Math.pow(10, scale);
				if(num - number > 0){
					return (number + Math.floor(2 * Math.round((num - number) * Math.pow(10, (scale + 1))) / 10) / Math.pow(10, scale));
				} 
				else {
					return number;
				}
			}

			function validate(id_name) {
				if (document.getElementById(id_name).checked){
					return true
				}
				else {
					return false
				}
			}

			function setCookie(cname, cvalue, exdays) {
				var d = new Date();
				d.setTime(d.getTime() + (exdays*24*60*60*1000));
				var expires = "expires="+ d.toUTCString();
				console.log(expires)
				document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
				console.log(cname + "=" + cvalue + ";" + expires + ";path=/")
			}

			function getCookie(cname) {
				var name = cname + "=";
				var decodedCookie = decodeURIComponent(document.cookie);
				var ca = decodedCookie.split(';');
				for(var i = 0; i <ca.length; i++) {
					var c = ca[i];
					while (c.charAt(0) == ' ') {
						c = c.substring(1);
					}
					if (c.indexOf(name) == 0) {
						return c.substring(name.length, c.length);
					}
				}
				return "";
			}

			function resetForm() {
				document.getElementById("calcForm").reset();
			}
		
			//end of ripped functions
			function ctb_pp_calc(stars, max_combo, max_player_combo, miss, ar, acc){
				var finalpp
				//console.log(stars + " " + max_combo + " " + max_player_combo + " " + miss + " " + ar + " " + acc)
				if ((max_player_combo=="")||(max_player_combo>max_combo)){
					max_player_combo = max_combo - miss
				}
				if ((miss=="")||(miss>max_combo)){
					miss = 0
				}
				if (!(acc>0)||!(acc<100)){
					acc = 100
				}
				//stars2pp
				finalpp = Math.pow(((5 * Math.max(1, stars / 0.0049)) - 4), 2) / 100000
				//length bonus
				if (max_combo > 3000){
					var temp = Math.log10(max_combo / 3000.0) * 0.5
				}
				else {
					var temp = 0
				}
				finalpp *= 0.95 + 0.4 * Math.min(1.0, max_combo / 3000.0) + temp
				//exponential miss l(osu!)
				finalpp *= Math.pow(0.97, miss)
				//combo multiplier
				finalpp *= Math.pow(max_player_combo / max_combo, 0.8)
				//ar multiplier
				if (ar > 9){
					finalpp *= 1 + 0.1 * (ar - 9.0)
				}
				if (ar < 8){
					finalpp *= 1 + 0.025 * (8.0 - ar)
				}
				else {
					finalpp *= 1
				}
				//acc multiplier
				finalpp *= Math.pow(acc / 100, 5.5)
				//mods
				if (validate("mod-hd") == true){
					finalpp *= 1.05 + 0.075 * (10.0 - Math.min(10.0, ar))
				}
				if (validate("mod-fl") == true){
					if (max_combo > 3000){
						var temp = Math.log10(max_combo / 3000.0) * 0.5
					}
					else {
						var temp = 0
					}
					finalpp *= 1.35 * (0.95 + 0.4 * Math.min(1.0, max_combo / 3000.0) + temp)
				}
				if (validate("mod-nf") == true){
					finalpp *= 0.90
				}
				return roundNumber(finalpp, 3)
			}

			function get_b_api_data(api_key, beatmap_id){
				var api = new XMLHttpRequest();
				try {
					api.open("GET", "https://osu.ppy.sh/api/get_beatmaps?k=" + api_key + "&b=" + beatmap_id + "&m=2&a=1", false);
					api.send();
					//console.log(api.readyState)
					//console.log(api.status)
					if (api.readyState == 4 && (api.status == 200 || api.status == 304)) { 
						data = JSON.parse(api.response)
						//console.log(api.response)
						console.log(data)
						if (typeof data[0] === 'undefined'){ 
							document.getElementById("error").innerHTML = "No Beatmap ID!"
						}
						else {
							return data
						}
						//console.log(data[0].difficultyrating)
					}
				}
				catch(e){
					document.getElementById("error").innerHTML = "No API Key/No internet!"
				}
			}

			function main(){
				document.getElementById("error").innerHTML = ""
				var beatmap_data, a
				beatmap_data = get_b_api_data(document.getElementById("akArea").value, document.getElementById("biArea").value)
				console.log(beatmap_data) 
				pp = ctb_pp_calc(beatmap_data[0].difficultyrating, beatmap_data[0].max_combo, document.getElementById("pcArea").value, document.getElementById("mnArea").value, beatmap_data[0].diff_approach, document.getElementById("accArea").value)
				document.getElementById("ppValue").innerHTML = pp
			}
			
			window.onload = function(){
				document.getElementById("error").innerHTML = "Create one at <a href=\"https://osu.ppy.sh/p/api\">https://osu.ppy.sh/p/api</a><br>Beatmap Listing: <a href=\"https://osu.ppy.sh/p/beatmaplist\">https://osu.ppy.sh/p/beatmaplist</a>"
				document.getElementById("akArea").value = getCookie("api")
				console.log(getCookie("api"))
			}

		</script>


		<style>
			.text-xs-center{
				text-align: center;
				vertical-align: middle;
			}
		</style>


	</head>
	<body>
		<div class="container" style="margin-top: 50px;">
			<div class="row">
				<div class="col-md-12">
					<form id="calcForm">
						<table class="table table-bordered table-hover">
							<tbody>
								<tr>
									<td></td>
									<td class="text-xs-center">COOKIES WILL BE SAVED</td>
								</tr>

								<tr>
									<td class="text-xs-center"><b>API Key</b></td><td><input type="text" id="akArea" class="form-control" placeholder="Create one at https://osu.ppy.sh/p/api"></td>
								</tr>

								<tr>
									<td class="text-xs-center"><b>Beatmap ID</b></td><td><input type="text" id="biArea" class="form-control" placeholder="https://osu.ppy.sh/b/{number here}"></td>
								</tr>

								<!--tr>
									<td class="text-xs-center"><b>Star Rating</b></td><td><input type="text" id="srArea" class="form-control" placeholder="4.20"></td>
								</tr>

								<tr>
									<td class="text-xs-center"><b>Max Combo</b></td><td><input type="text" id="mcArea" class="form-control" placeholder="1942"></td>
								</tr-->

								<tr>
									<td class="text-xs-center"><b>Combo</b></td><td><input type="text" id="pcArea" class="form-control" placeholder="MAX"></td>
								</tr>

								<tr>
									<td class="text-xs-center"><b>Accuracy</b></td><td><input type="text" id="accArea" class="form-control" placeholder="100"></td>
								</tr>

								<tr>
									<td class="text-xs-center"><b>Misses</b></td><td><input type="text" id="mnArea" class="form-control" placeholder="0"></td>
								</tr>

								<tr>
									<td class="text-xs-center"><b>Mods</b></td>

									<td>
										<div class="mods">
											<input class="disabled" type="checkbox" id="mod-ez" name="mod-ez"> <label for="mod-ez">Easy</label> 
											<input class="disabled" type="checkbox" id="mod-ht" name="mod-ht"> <label for="mod-ht">HalfTime</label> 
											<input type="checkbox" id="mod-nf" name="mod-nf"> <label for="mod-nf">NoFail</label>
											<input class="disabled" type="checkbox" id="mod-dt" name="mod-dt"> <label for="mod-dt">DoubleTime</label> 
											<input class="disabled" type="checkbox" id="mod-hr" name="mod-hr"> <label for="mod-hr">HardRock</label> 
											<input type="checkbox" id="mod-fl" name="mod-fl"> <label for="mod-fl">Flashlight</label> 
											<input type="checkbox" id="mod-hd" name="mod-hd"> <label for="mod-hd">Hidden</label>
										</div>
									</td>
								</tr>

								<tr>
									<td class="text-xs-center"><b>PP value</b></td><td class="text-xs-center"><b><h3><span id="ppValue" style="margin=0">42069PEPPYHIMEHIMEHAITAIAIAE</span>pp</h3></b></td>
								</tr>

								<tr>
									<td><input type="button" class="btn btn-primary btn-group-justified	pull-right" value="Reset form" onclick="resetForm();"></td>
									<td class="text-xs-center" id="error"></td>
								</tr>

							</tbody>
						</table>
					</form>
				</div>
			</div>
		</div>
	</body>
	<script type="text/javascript">
		document.getElementById("akArea").addEventListener("keyup", function(){
			setCookie("api", document.getElementById("akArea").value, 30)
			console.log(getCookie("api"))
		}) 
	</script>
</html>